# Builds CForth for ESP8266

default: forth.elf

TOPDIR=../..

CONFIG += -DBITS32
CONFIG += -DFLOATING -DMORE_FP
LIBS += -lm

CFLAGS += -m32

CC := gcc

# Change these to reflect the locations of external stuff on your system,
# either here or on the command line
ESP_TOP = /home/andrewh/esp
XTGCCPATH ?= $(ESP_TOP)/xtensa-esp32-elf/bin/
CROSS ?= $(XTGCCPATH)xtensa-esp32-elf-

# ESP32 SDK
# IDF_PATH ?= $(TOPDIR)/../esp-idf

CFORTH_PATH ?= $(abspath $(TOPDIR)/build/esp32)

include $(TOPDIR)/src/app/esp32/targets.mk

forth.elf: app.o
	@IDF_PATH=$(IDF_PATH) CFORTH_PATH=$(CFORTH_PATH) make --no-print-directory -C sdk_build

# If COMPORT is in the environment - e.g.  COMPORT=COM36 make flash
# override the CONFIG_ESPTOOLPY_PORT setting in sdk_build/sdkconfig,
# otherwise use that setting.
# The following line forces COMPORT to be imported from the environment.
COMPORT ?=
ifneq ($(COMPORT),)
	ESPPORT_OVERRIDE = ESPPORT=$(COMPORT)
endif

ESPPORT_OVERRIDE=/dev/ttyUSB0

flash: app.o
	@IDF_PATH=$(IDF_PATH) CFORTH_PATH=$(CFORTH_PATH) $(ESPPORT_OVERRIDE) make --no-print-directory -C sdk_build flash

clean::
	@rm -rf sdk_build/build
